![](https://lh4.googleusercontent.com/18oAPNp1uzZ6qY6bJxg2fWYWUEV-pQzNa_dSAqSp2lEjdg4hlEyLlQYc1OAowXxSqrp5Bk9iXRYOu-mECiqSr-gzo56d8QAh97VrfTbwX4uYN2ABB8BKM9XZK2mSzSXDN3qeHzp8xRsNHmALdeNEPiw)

![](https://lh3.googleusercontent.com/_-_DS9VDmI1QhI68JOiMchoWH7Bo1fqYn0qbD9Y24KH1T1zAG272HQy7cetrLxw3buJYbJEcj7TMjxv0CeWt-z1p4a3hl1FrNKPMROVo6L42XLIWFkjw_yPGlVTzhcPz1v2IB2JCUXMrAl4p2n9kbnY)  

# AWS CloudNGFW QwikLab Guide

<br/><br/>

# Overview

The goal of this workshop is to take you through the experience of deploying the Palo Alto Networks CloudNGFW service on AWS to protect your Cloud Native Applications. This workshop will take you through the three step process of using the service - Subscribe, Deploy and Secure.

As part of the workshop you will learn to deploy the service on a centralized model and experience first hand how the service can protect your applications from attacks like the recent Log4J attack, out of the box.

![](https://lh6.googleusercontent.com/kXTNtrCakPvH2zDkMi0_yNysFKYB4gAtH2SoWT8TiPSJokTSeZnQRWvUUTFNNh2-8GvfQbN63VEp39jTu2TvKaCDJPCC0PBbcNyUcNxmPVeaD_QjlUjA8hnXJ-JGEYGrVVMJXxbKR4WXIip7Jb7xHlI)

<br/><br/>

# Environment Overview

![](https://lh5.googleusercontent.com/VPI5mVmb-e4cxJbrKTTjRcL4ovKq8oLQ9T9fBKyAjBYqKBSIP1uIJxh5fTC6Lb9RPuAg2XNBBzgETdAyOAMuJv0NC4Ud_7gvrSCXzytIKBpLgEethf12RiyCBlnfwYduB1tJKYfgfeIeSNEsfBYB1M4)

**Figure:** Hands on Lab Environment – Cloud NGFW

For this workshop we have automated the deployment of the lab environment including the three VPC - Attack VPC, Vulnerable VPC and Security VPC, along with Transit Gateway and the attack and Vulnerable applications. This is achieved via Terraform, that you will be launching as part of the lab.

<br/>

## What You'll Do

- Deploy the AWS resources required for the lab using Terraform
- Follow the Subscribe-Deploy-Secure workflow to use Cloud NGFW Service to secure AWS applications
- Use the default best practice policy on CloudNGFW to to protect your application against Log4j attack 
- Gain end to end visibility on your application traffic with Cloudwatch

<br/><br/>

# Activity 0: Lab Setup

## What you'll need

To complete this lab, you'll need:

- Access to a standard internet browser (Chrome browser recommended).
- Time. Note the lab's **Completion** time in Qwiklabs, which is an estimate of the time it should take to complete all steps. Plan your schedule so you have time to complete the lab. Once you start the lab, you will not be able to pause and return later (you begin at step 1 every time you start a lab).
- You do NOT need an Amazon Web Services account or project. An account, project and associated resources are provided to you as part of this lab.
- If your lab prompts you to log into the console, **use only the student account provided to you by the lab**. 
- You would need to use your email ID to create the tenant. **Make sure that you are using the same email address that you used to register with qwiklab**. Ensure that you have access to the email address as the password reset email will be sent to that email address.

In this activity, we will launch the lab environment. These are the steps that we will accomplish at this time.

1. Start the lab on your designated Qwiklab account.
2. Login to the AWS Console using the provided credentials and set up IAM roles
3. Deploy lab environment using Terraform
4. Launch the Log4J attack on the unsecured environment.

<br/>

## Start the lab

1. Once you login to [paloaltonetworks.qwiklabs.com](https://paloaltonetworks.qwiklabs.com/), the Home page should display the Labs that you have access to. Identify and click on the Lab that says "_Cloud NGFW_".

![](https://lh4.googleusercontent.com/_bsbMB9jVUzncgrQkx7AR0v34dkG0p1XYiigiVaWyCp-gP-qTBzrzs41YbhN2osEtpPWW0_XwdO7Eujb6yZnBwsWbTt15yupmnunliEZotJvsK2OY-kq2vFulD-7KXCLoYq4-KDZxrtanMjyBGHATfc)

2. On the page that opens up, click on _AWS CloudNGFW_.

![](https://lh4.googleusercontent.com/_nV6ev5z26rKIzYS-PHXlwAh7iF0LVePRa4K3RwvtHNduPqgjGHtWLmsEspNBfbyGUTXkdDOtk4-9qExCX-MHfC4a138RYrQQQgS8wA_FLZMl8tqmp9k3ZbvgZS6sGs-fAlvJmgkufT5UkavWT1Xocs)

3. On the Qwiklab environment, Click on _Start Lab_ Button to start the lab.

![](https://lh5.googleusercontent.com/0r1NgpSFO3Q92__VLByEVi6rEqERc7oEWnm1t2C57YTvCS8zHqWLxoRgQ0SqRhZKiMpz8aatT1gK7GN0BUwhT1wBgFU-nhZ_N6zLEZH5KOmlHgiQCmwbn5W1Y5dUERHc66Z5CazBw_20y9opHD8JLWk)

At this point, Qwiklabs will build an AWS account for you. In order to access the EC2 application instances via SSH in your environment, you will be using keys generated by Qwiklabs. There are two types of keys generated; PEM and PPK keys.

4. If you are on a Mac system, you will be using ‘Terminal’ to connect to the devices via SSH. For this, click on the “Download PEM” link. This will download a file named “qwikLABS-L\*\*\*\*\*-\*\*\*\*\*.pem”.
5. If you are using a Windows laptop to access this lab, you will need to have a SSH application like PuTTY installed. In this case, click on the “Download PPK” link. This will download a file named “qwikLABS-L\*\*\*\*\*-\*\*\*\*\*.ppk”.
6. Make sure to note the location where the file is downloaded. On a Mac, by default, it should be downloaded to “/Users/&lt;username>/Downloads”.

![](https://lh4.googleusercontent.com/oczonF_OFF2aIoAFIBjgrslmESuA-9jOQbzItN1SeX7y2C7W7eZja5iRrfMhcMGjtW3ab6h0QXbN7G0ApQLo-dSdRtIRnM1qAIqalzXZ_OwGNvUVTmS-cp-4nwSNU68EiRSJ2aZVKaZQOSc_0LreUgA)

7. To login to the AWS environment, right click on “Open Console’ and “Open link in Incognito window” for Chrome-based browsers. For other browsers, use the appropriate option to open the AWS Console in a new private tab.

![](https://lh5.googleusercontent.com/l0z9C_m__jhWFNGZqHCSj43rR8MvhJt3wwiyaWpW2_tJ8G10fMs-nbJ8vfe4_j5JVN6idaXp2dy569l_Y0q2rBCo95NZY-PtkzGB2jbouip8QK8LlVZA1lYPXSazCLFLMHFWBGR4cyYIG3IlFN-NKnM)

8. On the AWS Console, copy over the IAM username and password from the previous tab.

![](https://lh5.googleusercontent.com/HCDajRVoMVEKo-otytgg1uNZ647qBara8D8bMdLf2rz-eqJ2U0fNx6Uiazk1epf1o2lWdfTTAafdbSSib_vHvj0i9ZBDlyU-BFdjf08Ef-kWTTgKpnEH0UScV2LfQm3vFc2WEpSAqs61jJ7_jbY8CAw)![](https://lh5.googleusercontent.com/7hKDaNW9P8e_l15slkTp_ljAsYD6i7VvXnff4LTikLd2O_d6NV2Oppn3l_MpB9O4Pi5EAUG7UMdxLoJIGYv5Otk3qR0Cr3tNO8ueZyg7jK79PRZe3GSKLweTfvtMDcimfCxvY-BfmHxt0ZjFwi7sz2U)

9. Now, click on “Sign In”.

![](https://lh5.googleusercontent.com/g2_-28J7hIMcxOYMUTBee0YUULU0YT3ss5qQ8PKkAKIlk6EZFn1t8wY_IRxE7pAGQBeD32OWl0TBtvwpsLrb4jneHNnvSDpVr7g-U1Ea_t_HPCoCmT2zkCGPGzI0niEizA5xaOud7zFEl-zrIL9rDy4)

Once you are successfully logged in, you will land on the AWS Management Console.

![](https://lh4.googleusercontent.com/mV30KneSuSeHTgOsL6EAtbYo2MfxWfB1_5Qf4h2oKEEpfyJpBk1zL_b6U3TR3Vh7Ho8LFVDgnn4VeB_QDX8oWe4rABbaxtEOF9yHBEiPY84gDYFqVNZU0QNDMV6DDrsTF2rrC4p7Vf9NTCPNXbE6--0)

**Figure:** The AWS Management Console

<br/>

## Set up AWS Account permissions

As mentioned earlier, the Qwiklab user account, by default, does not have the permissions to AWS Marketplace and CloudShell services, which are required for the purpose of this lab. We will now edit the permissions for the Qwiklab user account to provide access to those services.

10. On the AWS console, If you see a message for ‘new AWS console’, click on ‘switch now’
11. On the search bar type ‘iam’.
12. Click on the link to _IAM_. A new IAM dashboard window will open.

![](https://lh5.googleusercontent.com/IIC0WpHtWTVVGbH5tW3QfmuC1vZoLj0kd-ZgUBj1gwUlmqEDB5vV_jf8wx7AzofURz3sHoVuk1BTW63oQpSgqa-utDECA34_ra3Aa05eUhokDfKvOVOuDpfvLPYpNVRiubcntboax3hLjdqM5TYoHjA)

13. Click on ‘2’ below users.

![](https://lh4.googleusercontent.com/3XWAlRzPNTe8ZK6ZuKqz8XnLDFVGKmMLhUbqmEPu3XpFVYoi8C0BO7ftl25rFmb9X7uqbZlXKPmreMZVS4JNsm3xIGN4KTvbCLikrp8QyqSHlxJ1eCw-XmbMVIU8Aox9ciu1BfvIIWpHBVm6nuD11dk)

14. Click on ‘awsstudent’

![](https://lh6.googleusercontent.com/oEZFlHVVh-Vp-VG3Z7XswxxcoufQ8Nyv7dNzEn0oPbAg-IYgLaOMk2YSWmP5XGcvVfjb9HW_n3J6ogPPEhjacsi9dubaDwstZRlwmG8rAWtWWhNANgtY-pF0uzD_h_4Ty7gko4mJGCa1RiXtCnApNOk)

15. Expand the default policy by clicking on the small triangle icon against default_policy in the list.

![](https://lh5.googleusercontent.com/AvZJN6qYrwNjFJ5wO9pwjlf08EylNzedeV-3q5xBTendIq9_fZvLZbNoUfe2PW_DOStnLUBMG9wVdlkPFZDPSvxi6HVx4KrcFkVbOEVV3znO7OHApkAfAUIS9M_PyrhALhs8p-GHCFa-k0SpuQs0utw)

16. Click on the ‘Edit Policy’ button.

![](https://lh3.googleusercontent.com/d91ZwZVnsvPyivHluwhX-Er7RA95TSsmbqb8knyQCVKHfIuPE-tZkFik7MBGC5s0zhmAwv9X-2-zeMYFB4Ygvrs4nRywH8X9qPQ1-KbwQyQY7tlWHdtLlSCdH5L5qvyQejRLmDzVJMxSqPF_8Dax8DE)

17. Click on ‘JSON’ tab

![](https://lh3.googleusercontent.com/6pSt5bHbnK9fjM04C7wjJO_qWYIvqkmIgdaqGs4t0-BfXheTWDljGi3UV0IhAJmE3zWUy7Xa22CavXIgGnDQMgcTnXlSYq2lTm6PHPG35DoG732q9PKSa4OruEa_yt1TWLmuQln-_VOS_FT-B_OmQbE)

18. Scroll down to the Deny policy and remove two lines (**line number 27** and **line number 36**) listed below. Now, if we delete line number 27 first, all succeeding lines will move up one line, including line number 36 which has now become 35. To avoid confusion, **delete line number 36 first**.

```
"aws-marketplace:\*ubscribe",
...
"cloudshell:\*",
```

Make sure to delete the whole line.

![](https://lh3.googleusercontent.com/32M6yhm81zKln_h1fZYwO5RoHt2QiaDvdYGDIm3xZmN3Ij-rOlR1cjZZwYpEEGJnfXycDOwzIMD_-swf6ST396Ag2zXfm2xXzNe0tkevI0dOYoWDHJd_UpydNmP4QxFgHij4wiQoe4x9KmWPIdBF8L0)

19. Click on ‘Review policy’ at the bottom of the screen

![](https://lh3.googleusercontent.com/WePriienaj1aupaPvwvSqpOui2qgFni8ZNzupl1ZIo0bBH3rczEn2curUzpcY4C7NtFy7Z--01S1RknIUUYt9KKYsxR4V4ScaqNbOF2KBZe6eAoM2hNCjMqv2JN0MHOfHjZOxcomvwjk_fLGGgsp48E)

20. On the next screen, click on ‘Save changes’

![](https://lh3.googleusercontent.com/E6vjqzn6pD1YWTGsrjgCGrPhKko_5X-EPri6P7qfmnc0gIWg00iE9EaE4jgR_1BQktD68vi9Gxf6R0tO8iJXsTB6GwceYSSKxoMqV1Ghxi_1GHP6vYapFGJkzaapBbHKBeGkC6rG9fZPz-bB-MqP0_M)

21. Account setup is now complete.

<br/>

## Launch lab environment

In this section, we will deploy the AWS Cloud resources required for the purpose of this lab using Terraform.

22. Click on ‘AWS’ on the top left hand corner to navigate to the primary console.
23. Make sure that the region is N.Virginia.

![](https://lh4.googleusercontent.com/17hvAgfiGMAi3ZDhTsf-4Aa8WV0Dbx2_pL13mV9VQLkX90ZG10g1gH_cWgUfpwztVw85TnG2DJ9KaDdnAUBH2BK2V8Og3vzJYeiaip4l2CqI-24rGyrG9p8c9RdzVYeVAWDDCATh194h7h-6rKaEq30)

24. Launch Cloud shell using the icon on the top right side of the console

![](https://lh5.googleusercontent.com/SHIDJzgCIUHG7jzy3L2KmxM3paX9roN-cRa2UzO7yjpDONul_TF3Ejj-OZsxXoK2-mtrKcbu-Is4gHD1bmtyEolma1Ivq6rU86YeQJvkVfZ8d8UXhJ7YvCZoWTPGYFIpZMgWqtxZyYfP6vW7XJK07H0)

25. Close out the welcome pop up.

![](https://lh3.googleusercontent.com/CMr4EgpUyiV9m2WYyH7VBmPCqBNV8pbLyIlgzzGBdbG0oRJLtUdIxaFG5jrJ6u2Jr1MOJ4Wxmq2I_UvdDexeIZxZmi2QVXOpMtnEYQ313_YFpzPnga5l_XOfC54f2AytFPAdGfmUR1CUEG_aFciEhj8)

It takes around a minute for cloudshell to launch and to get the prompt as shown in the example below.

26. After the cloudshell is launched, we will first ensure that the home directory is empty by running the below command.

```
rm -rf *
```

27. After the cloudshell is launched we will start by cloning the following github repository.

```
git clone https://github.com/PaloAltoNetworks/lab-aws-cloud-ngfw.git
```

![](https://lh3.googleusercontent.com/qfnCh-7ezoy8s1XI_ciGI35-fRwO2nVS1aSZMGpmPMWYsQ2NoGmuRUXv2o2_7or3osoBc24QZO0c0He-4uYDRyM9sUJ4sZQyfrk5L8-Sa6fuHDECqw51gjkQ8dEPbJeUr9knPwRxCcd9KPqSid0lkVA)

**Figure:** Example of cloning the GitHub repository

28. Change current directory to git repositories’ root directory

```
cd lab-aws-cloud-ngfw
```

![](https://lh4.googleusercontent.com/cYS_YU2DIJfAzss3XcllJ3VVWPNKaOXYSKd21Wes_p5v52Zr4iNzxMmv1pnsiAB9rfE7_hwAZvRbIytw9-6ip-FVOTYP8uJshHI4Xpyk1a3cHEPTC2zhkoTI9kINK3cA-uAWn1dhYvC2PEe2wTyiLRc)

**Figure:** Changing the current directory to the repository’s root directory.

29. Run the setup script.

```
./setup.sh
```

It will take a few minutes  (**~5 mins**) to deploy all the lab components. Status will be updated on the cloudshell console as deployment progresses.

At the end of deployment, you should see the message “Apply complete!”.

![](https://lh4.googleusercontent.com/xt5X4tbmUZTvJr6rL8FLekSzv4sFgGLbozWMvWlhRNEBBQgjzS50xKm3EjzyKi0jDsHI1bizaGUoAE_27cZQG753bb09qJJ6Vx-nlRDghsthrkraFICIqvLfKEy4zKBArCHql0ydjbqiBnH8FsFGyXk)

**Figure:** Completion message of the Lab Setup script

Please note the public IP addresses of the Attack App Server and the Vulnerable App Server. You will need to login to these servers later in the lab.

![](https://lh3.googleusercontent.com/sej6-whSsdJwSyi_ukbwO8_NOWPWeWkTIlxiK3Lms5e-UEDJpaHhSHP8IVgsbUH2dC8LXRDKYdIzs419UiATZFuwEN4Tcp8ywbr-pwZu_geFaUN0Ak_5GX5Yfd3U5MVDxlFJ7FFMfrBhdTfrvUsb2to)

**Figure:** The Lab topology that is deployed using Terraform

<br/>

## Check the Connectivity between servers

30. On the AWS Console, in the Search bar at the top of the page, type “EC2” and from the search results, click on EC2 to open the EC2 console.
31. From the left menu, click on Instances and identify the instance with the name “**qwikLABS-vul-app-server**”. This is the Application server which will be the victim of the attack.
32. Note the Public IP Address of the “**qwikLABS-vul-app-server**” instance.
33. Also, identify and note the Public IP Address of the “**qwikLABS-att-app-server**” instance.

![](https://lh6.googleusercontent.com/Z3XHTNq3D1HJe73rSP7TlrjhZAvlm3sYwGolDGYxqc3Q9exzfdUh2SEFEtsGhYKz_MKDRUmzAqyAtXNO1_a8dURyfarwciYwH8bGKmBsnGxLptldt4dslNe7YkhK82BLc3sz-lmaGL2RsvzAyMODeiU)

34. On your terminal, identify the PEM or PPK file that you downloaded from the Qwiklabs console and update the permissions on the file to make it read-only. Check the example given below.

```
chmod 400 qwikLABS-xxxx-xxxx.pem
```

35. Login to both the vul-app and the att-app servers using the downloaded PEM or PPK file. Check the example below.

```
ssh -i <qwikLABS-xxxx-xxxx.pem> ec2-user@<public-ip-vul-app-server>
```

**IMPORTANT:** Note that the login username to be used is “**ec2-user**”.

![](https://lh3.googleusercontent.com/O9G3r2JGwEiYz4JMX9JdpYHb1DBvfVgFGswG7J_B7Qwnyj9mIdJTX5SZgvPlzAhCnXHF5c1OAV1ioAnKAjX-wma4M2xldJO_1IPRSHgG35px7d8p71p9-nJzm4ToqoB5mKGObYH3CBwvreta1wNhZVU)

36. If you are using PuTTY to connect to the servers, after opening the putty, 
- On the Category menu on the left, expand SSH and click on Auth.
- In the field to select the _Private key file for authentication_, browse for the downloaded PPK file and select it.
- Make sure that the file permissions on the PPK file is set to Read-Only.

![](https://lh3.googleusercontent.com/AZ4MqC_uYuzCBoucLouOncwxgexCBvVm1XfkWMhYSOHf78vDXCLgG4fbViY-0ce2MJV2JEgBu986-4gnJHd2W6v21vxP4tisQawzUbF5cjLmnqkQBgepSIrXCQzvq2iry9zLaHMyxiqiajdamV6J5V8)

- Within the same PuTTY window, on the Category menu on the left, click on Session and provide the Public IP Address of the vul-app server as shown below.
- Click “Open” to connect to the server.

![](https://lh5.googleusercontent.com/vkzc1ZDh7ilp_yQi0iUIyILHHbM0vp_Y7ihTqRjrj0WoeTVVojyFmdZXD0e0qVwQhR82TjYRwlwAZq_HV5HNsY90jAGGW2QK6_cNnbpzJNBvsd-Wh_R2mM-hx4X9QsZskX33wErtIMJf0RAYd0OGGt0)

37. Repeat the above steps to connect to the att-app server on a separate PuTTY session.

<br/>

## Setup the Vulnerable App Server

38. On the **vul-app-server** command prompt, execute the command below. You should see the response output as shown in the figure below.

```
sudo docker container list -a
```

![](https://lh5.googleusercontent.com/PjSBjf8dmcB_28zk3sPjH2N1h1o-dfipPBcvf7dzUSS_2w985eQpGKea0VIU5Sk1nhuQ2W8uXr69yj-41X6v83s_mhnmumuRMzk1CBHP2cw-6KH9MU-cDkE_6IzFMnNxeyV_ihqTLjmvtQoQHX0uzRg)

39. If you do not see “vul-app-1” container up or the command errors out, look at the troubleshooting session for instructions for manual start.
40. If all is good, run the below command to update the “/etc/hosts” file to add an entry for the attack server.

```
sudo docker exec vul-app-1 /bin/sh -c 'echo "10.2.1.100 att-svr" >> /etc/hosts'
```

41. To verify the update of the hosts file, try to ping the att-app-server using the hostname provided. Press Ctrl+C to abort the ping.

```
sudo docker exec vul-app-1 /bin/sh -c 'ping att-svr'
```

![](https://lh4.googleusercontent.com/Seu_uSatSZljATtyOFpnf6tjqVYhpl7m8t5XpbgFa6dlaSOS39lkNcCBWISAJ0K9bxbhA6dCM2HMOEB9xSo6Lz8ysggxVVHWKqjVu7V3ku2tcd2j826KxIBj1XF6vhx9h984u72DFf-nLiqg0ywtc0k)

<br/>

## Launch the Log4J Attack

42. On the **att-app-server** command prompt, execute this command to launch the Log4J attack.

```
/tmp/launch_attack.sh
```

43. You will get a “Hello, world!” message as a response indicating that the attack is successful.

![](https://lh5.googleusercontent.com/klPplw5XUmQnL1TMsqX64x08w5a9WD8udr8EHg63AjJccuJ2IHP3tbNqwKAlLB7vXh1C9nYrwISYwiZfej0nQU5Hoz6CGR8NG2azRej-HbgujQlwQHkE5lvgMEvbbZxCyhMQvqMaDeFCtRYQIwt3d70)

44. Switch context to the **vul-app-server** SSH session and use the following commands to connect to the **vul-app-1** container and view the ```/tmp``` directory. You will see that the vul-app server has been infected with malware.

```
sudo docker exec -it vul-app-1 /bin/sh
```

```
ls -alrt /tmp
```

![](https://lh5.googleusercontent.com/wDXixyTsMKEro1mx9hXN4snqToRVgFDSRDY5Vqj8r1LJvgKb4oxJqUEwhv1yfCqQRp7I2918YGw4wgYlMKVU3VKcYNsqivFmw6n_GOO6kw36n0G6f0jroR9vfO1aUVzdmChvKev_lbyuHodgi8oInzQ)

45. Let’s delete the malware-sample file for now, for our attack attempt post the configurations of CloudNGFW.

```
rm -f /tmp/malware-sample
```

<br/><br/>

# Activity 2: Subscribe

In this section we will first get the AWS lab environment ready. 

## Overview

- Subscribe to the Cloud NGFW service in the AWS Marketplace.
- Create a Tenant Administrator – A **Tenant Administrator** is required to be able to add AWS Accounts and Users for accessing the Cloud NGFW service.
- Login/Change Password – Initial Tenant Administrator account setup.
- Add AWS account – Once the Tenant Administrator has been registered and logged in, the AWS account to be monitored must be added to the service.

<br/>

## Subscribe to CloudNGFW

We will now subscribe to Palo Alto Networks CloudNGFW service. Please follow the instructions listed below.

46. Use the AWS link to navigate back to Console

![](https://lh6.googleusercontent.com/JcYCQtSel07lRKO61-hGLUPBNu_-lUcYs3gvVLHTbXcS23tIpF-tpOCw9vj14yzCqRRUMf32XcsjwOg4oxUCVWIgQu5ApXGbvdUmbCmoiDhffQckszlwhF0D-ip-uZyJ0U0pgxlinfjLQ9Ju8PkhB1I)

47. Search for “marketplace” on the search window and click on ‘AWS Marketplace Subscriptions’

![](https://lh4.googleusercontent.com/TvKinl1Oc5NLMTiGebxMlvNRSIxVBKG0ESZ7YzZ0DIquP5x93GvLPIEa_yKIxR5q_TOgXS4LlwgQTFjHnrC7zMXJwUFWosrwzC5vJpg-uPWgd8DQgKYfMF3NlR-b4q0NU1Hp1h34mjkVZuvUtzyKr9w)

48. By default, you will land on the **Manage Subscriptions** page. Take a look at any existing subscriptions to see if the account is already subscribed to Palo Alto Networks CloudNGFW service.
49. If you find that the account is already subscribed to Cloud NGFW, we would need to cancel the existing subscription before proceeding further. Click on **Manage** in the CloudNGFW box.
- If you dont see any existing subscription for AWS CloudNGFW, you can skip to Step 52.

![](https://lh5.googleusercontent.com/50qYInXqaHI6NlSDgDH_fhagrpWcvjSsn1gAxk73Hip_ybkgaJLxcmEsGknHaZ0lvvKG9pPEaT5H_haQ1v6yowAFqRmD7c_XP2DlyMH5ZOMXJeGk1HV8Yyy8o-G94Md5-7hUGneInUrFrXiHvLOF9Tg)

50. On the page that opens, find the section that says “Agreement 1” and click on the “Actions” in the same section.

![](https://lh6.googleusercontent.com/OESfBB0nsTZDCF7iJS2GKVmrmh6Q_pRrudfraDFCFebbFW2at-KZbbp368-i8bCIZlboAYUf86SBLnoKiA46loxtmSUwefDFZmRpvxuDbroJN7Sc507jt7yo0b3oto4ECr0KGcHLMnsj4R3j0-w)

51. From the list, select “Cancel Subscription” and on the popup that opens, Check the checkbox and Click on “Yes, cancel subscription”.

![](https://lh4.googleusercontent.com/pWwgAsv6VgoR4gGOJnCmsCbIGkuprSZzY_H83p-Cv1G4mK1t88qZ__3uFBFqTQ6M5URc4RhoUVdk11LWj8p8BUxmgmuVbIUoIFwHsYOG8YeJo3rO9Wz5pkuBRVi44c0t9S7gazAVtV7qOrIJQqI)


52. Now, click on **Discover Products** on the left hand menu.

![](https://lh3.googleusercontent.com/PgnR66jooEX04NanfDh1VYuoTl3ROfgcdxR7RlPzt4dgyyaw2m5PoroNoFLuHvmmeSj8zP138GMTJeRaJbFO7xFZFkCpASG7R712rHRkWcPEQF0nUlMFG6K0KBoyeLymLjWP1aQpW6MLovWENDKDvDQ)

53. Search for ```cloudngfw``` and from the search results that appear, click on the “Cloud NGFW Pay-As-You-Go” link.

![](https://lh3.googleusercontent.com/P7phsv1cK1DDo-ZuuT9lleSwF171k36VPg0B-I_MFScF2uGhM8rD56gw64M0R7DKTjWig-ulv6eKna3h6c45DPHQAGXzRTCLDxAWw68d8Y87fj2_kFF28YwCIZywlDBosfKM6W-t_ulbnAmZXXKZXfA)

54. Click on the ```Continue to Subscribe``` button to start your subscription of Palo Alto CloudNGFW Service.

![](https://lh5.googleusercontent.com/Xxz1G_OyBf-DJ80bsvTimQ5Xiiym9ij6-86wyDuHF2WHe7L5bqu2pZb1udHoyPpzuvJz3jpIlxLGoBlXcL0YM1-Ubm-uLu1WCWG0Ggpj3dBsPv4v51rQ5H8BXTMBA5EeuWtS71xOHGKhEOdJvfxxwl4)

55. You can review the pricing details and click on ```Subscribe``` and then, on the popup that shows, click on ```Set up software```.

![](https://lh4.googleusercontent.com/xZS0JblxWfnD3YlZubkKNCzyeOMCFnUthMwsKG9Se90FuBq7oG-LJ7rlgROBC4D3BQoDpINHTFrx7wJAQ4pPTYwYQGlGO3kfHGHHGQlCfZqoJJuKrboUA_D6TLu3rdcJYBnuJAXaSzKenCI9psNra3Q)

![](https://lh5.googleusercontent.com/e98EAwzx5f2lWTunK0ehtAFwFewsGolZD0nCAqqCR_7Trk4-LReisxJTbX5Cs9LDAXq-47733PdX4AJBVCnugwf-9PxzwF4YqdVZ_yirw9QDhpq84A4pXPGVws2qB0qAs19fYVyCjHfTMtU5hzHfrlA)

**Note:** Since you are not using your own account for the subscription, you will not be charged for using the Cloud NGFW Service.

56. This will open up a new page on the AWS Console where you can register for using the AWS CloudNGW service and also set up your account for usage.

![](https://lh5.googleusercontent.com/f1q8n8Vd2qQpIsobZs556AVkUCfcxOB9LeDnfNcL4aiADpS4AcAGiboT49KVs2nQKs-18FqPNgdGtqAArSETOosRBOg2htSL8wbhddRAH7V3yvfPYB9ouVqnyGkbSfrezUL7YDBm9uq8IMGcrlPR4_A)

<br/>

## Create a Tenant

57. Click on the ```Login or create vendor account``` to create a Tenant .

![](https://lh6.googleusercontent.com/6FQVmdl6pN_KHI5B7n7DzEQYlqRjHSAKAEgDsdG17cvoRF0hwUgJZw2K3Te0xMLf6WM96SYgc7jRw0179-Ah6VVa1kke8qw0cBCaRVrphRu6fl9e6PqwxYz1Cc8mSqESfxDYfYLCMS7TgMYAys2JRaY)

58. Provide an email address, first and last name.

![](https://lh3.googleusercontent.com/lmIJ6cLp7OF5vXjOYPGzSwODaSGvNxQm0a5poSk7rKsNT-FEWwFd1T4dtILzWEG7NZYd2X_CxOzpr9jVqy8bsW1P--x_TUqOvbl14hlrnCmcd6zwXY5U089CWTG5b5tJyk1OyUCqtq0J7FYI-zmPsTc)

**Note:** Make sure that you use the SAME email address that you used to register with qwiklab.

59. Once you click on Create, an email will be sent to your email address with temporary credentials. Sign in to you email account and check for email from [noreply-cloudngfw-aws@paloaltonetworks.com](mailto:noreply-cloudngfw-aws@paloaltonetworks.com)
- Copy the temporary password provided in the email.

![](https://lh3.googleusercontent.com/-TiEenVd7a6990zv7LMYuS9uIcfW2zjHdkBrJjLXRsMM-58ztzLynja8pFVcHa9V7ZDn_wdcAlpNdfnRvyLtqbP0qDu3-M5QutY_gF4notWGoBxA6UZkP-Nm2JKGlPA4AQs69bK749rxKZcbs-uBSCk)

**Figure:** Email received on registering with the AWS Cloud NGFW service

60. Go back to the AWS Console. You will be prompted to change your password. After you have set a new password click on ‘Create’. 

![](https://lh3.googleusercontent.com/jojuUYO8Mg-TCOLEBdhoG0E-_-mi1ZkfDztKjiKty75nfbAUCgGj18aNdAc6M6juRoGcFfBts7btt0YpjQ1BraWlzk6vBoc8tNnIC1txdVLQarORmsx3TyuyrPcKDo1-CF_fDadX8GPTjru8XkH-UtE)

61.  Link new account status will be changed to “We linked your vendor account”. 

![](https://lh5.googleusercontent.com/rOTNqX3DmXnLtDCwpWqasAMPlDTDPaZDDTLIwE5Qc3kJu_rMjVri5wYvUH9Q4XnM5QysdtizX8s2aQyUDRqX4qEoOct7kzGiFhc5goXYeXSOKri52ADeZclHmEehgZwyqyK7xdIABrvH22otpOe0Rtw)

62.  Next click on ```Launch Template```  to configure the integration between your vendor and AWS. This will launch the AWS CFT console.

![](https://lh6.googleusercontent.com/u2c4dJRj6JRPkvnaHL3wfZRepZR9t5Cr-r-V5Udaoig99Mk8tSfunwa9_r1pW7j5gaZ705onS_4zkvdpqiaJj_pX1fAs8p5MbJXChBQmdDjC4cPTGOMh3lLua255o8lMK9MO59-LcPLJRYZol5WhuuM)

63. The “Stack name” field will be pre-populated with the value “PaloAltoNetworksCrossAccountRoleSetup”. This must be changed to something unique to avoid any conflicts. In the case of a conflict, you will see an error saying that the “Stack already exists”. 

![](https://lh5.googleusercontent.com/t1lZrQJ3XFb_v0Mm2WWLPBuBA4VfM7GWb-Si0rxSAIp4lGMvo9qx9KvECijB5DCGuVUXne00Y9Pm9jna1I60Ok9XyaMibCWAOy5ETpeKcTWOPWLxl99KX319n0Ih94lgIqrM7c_XvT5DFCJudLETqew)

![](https://lh6.googleusercontent.com/ldspitreDvzQhOV793Io9DCFFBvbD3nfX0662-QON_H_dA1izO26DpFBbfAtlKPQNVHpZLlQWjcIGRrQDFjleNCB9ZtVFh_fxqGGEbiDq7wnUa3QCq3vK30uWkVSkqrz0Jvr67Y_U8pCyoJvGzMir-o)

64. For all other fields on the form, we will keep all default values.  Scroll to the end of the Form. 

**Note** the Cloudwatch log folder name **‘PaloAltoCloudNGFW’**. We will be using this later.

65. Select the check box to acknowledge.
66. Click on ‘Create Stack’

![](https://lh5.googleusercontent.com/Faa5ZA2RgSI4uUJKEjPPQThaZMHzwiKxCDmz1LmWCcttSfaorxt-YWJetQDXBluA5nQ88V5aWbXRX_mwRakmF190K8pDDp1k29SiGyvEbOgmAVaonkBfQ2Z9UgTPeNfZTAQNdopT4tJ-culNrOnaoM0)

67. Monitor the CFT deployment to ensure that it is successful. You might need to refresh for the latest status.

![](https://lh6.googleusercontent.com/-1q-6SHnTguLgb7w1Oky_JthA4KuHaMJ1U9oTPmS0mnufr-q7DF69e_0aAZFPYGpw--DAIJ2qqBTbRrZ0uFYHBrBm5_3RtI89znrQn0MZwn4rgTI_lK-sr10FYORyUeaSUSgotWSP7NXHEWNss2m5u4)

68. Now you have successfully subscribed to CloudNGFW service, created a tenant and associated your AWS account.

69. Click on “Launch Product” to log in to the Cloud NGFW console.

![](https://lh4.googleusercontent.com/PeLVGPV8fHasTQlmaSIHRwUZEQv02duW2BTjBKTpXURhk3ouH_4ZHW65ndwf2-laGLXQcbNtxrp1TxRAOj6sZ61UVr8gW7XwP5uAv1WPZWjfVAz6qaiClN427jPHHWWIXVQMY4YTvNXWMlCksYdAJHo)

70. This time use your new password to login. For the support account, provide organization name and address. (Fill the mandatory fields)

![](https://lh6.googleusercontent.com/Hw4oCamOrUeWTosCCoxN4Evgd1kkoNZa6n2OcIJwr-E1EBliuRqIaUHEGBuGZd0YPMFrJ-lggFxV_qWPWomE-rsuM6fBLYeC7ga9alnmvIiUP297TCydjXEjUiR5hoeotkK1cPlxGm04hFyZXXKAj-c)

71. Click the ‘Close’ button to finish creating the tenant.

![](https://lh4.googleusercontent.com/pEZY27iLfSkBSaOrVXF2UboVD_9tGsUj7OM6_Cfj3P9puSYmU9Ig6KbCOsExuAF1vH0iUodO2DNvSGDYYnY4mTblbV1zcWZAJxb11o9ISz5mV-ocd4k8wwuyZWeXZipEGNlWmxVkey5t1XaWQYIzIH8)

<br/><br/>

# Activity 2: Deploy 

In this section you will be deploying CloudNGFW service on your application environment to protect your application. You will 

- Create a RuleStack
- Create a Firewall Rule
- Create a Cloudwatch Log Group
- Deploy NGFW and Endpoints

<br/>

## Create Rule Stack

72. Navigate to the CloudNGFW console. If you are not already logged in, open the link below on the browser tab and enter the credentials that you used to register earlier. 

<https://web.aws.cloudngfw.paloaltonetworks.com/>

73. Check that account addition has been successful.

![](https://lh5.googleusercontent.com/O94-VkijkpzNiTl6jVl7HwaFghspy8k2DUKSNukzp2L_IDcrkK3Nx0sNA13JLqpTjPaXJ1Qv2W7F--1We322XOGyTrY2KBPl9DpoGXLT87HTH80r9Az1_N5OJVg6_O3qKF8pMqgnI9ef0Dib4KZ9SGs)

74. Navigate to ‘Rulestacks’

![](https://lh6.googleusercontent.com/w8cpdoKDqRsEaSzhcbn-vQV4YTCWYTgv10NZ46cqqYfREsQXWFjUYZ9z-SOBqiIoDuv6ipCpqbDXLT-VUh2XCmiv-lHo9mlHCawWnvErz3I0UJq6z-KQyioZRN18w2eRBEGAana6A-ORpytJwwS4k5E)

75. On the right top corner click on ‘Create Rulestack’ and ‘Local’

![](https://lh6.googleusercontent.com/h-7G2hcK1kamyoTTDn4tgZ8Adk8TCwSWT00L_rBFUbQ0vTJLwiLbDcP_PZZCFtNR4dsNUdC2sQ98IcmHGgUEKk_U7GWqFX1D3dLE954nSmccSRrUXYu23aY0P34PUs1i4qYivMKwLD1V5ldqxJEm1mI)

76. In the Create Local Rulestack form, 
- Name the rule stack ‘Rulestack1’ 
- Choose the AWS account from the dropdown.
- Click ‘Save’

<br/>

##  Create a Firewall Rule

77. Navigate to Rulestack and click on ‘Rulestack1’

![](https://lh5.googleusercontent.com/VyhB6hAv8QO2H2bGa5jpDwY5LRyBo5A92qOSWCp0YGlnfTUaNaawJ8ty8fRA5uZh4AtH9tiul6S8HFASqjyj5I70RcsULOeqAXTtbaXEx1xXD3mI8d3jOHB6sZfPw3UggaC1B15aX4AImgG5yMr4naM)

78. On the Rulestack page, click on the ‘Rules’ tab and click ln ‘CREATE”

![](https://lh6.googleusercontent.com/-a3a9hbzZvlfuLGzuRZPA3tPLvU3QLbat6dLB_IxtSQEFPH7b5Pi8jbOUzfB8pS4dKX3cdWpADt8yH2EspkLa0Qc4TuzYNUl3urWSyYUJbO0TVM8MBYG8ozP4MmV6JtYbTc5oy76cmbp_NefR18aGis)

79. We will now create a rule that allows all traffic, but applies security best practices through _Security Profiles_. In the General section of the Create Rule Form,
- Name the rule ‘MyFirstCloudNGFWRule’
- Set the Rule Priority to 1
- In the Source and Destination section of the Create Rule Form, leave Source and Destination values as ‘any’

![](https://lh3.googleusercontent.com/H4mr3MQYwT4VZH6tXbuMwivBZzSJK6ZPJtbolwzLtvPrUL0WEksOnoHFToq2w4A140lM1bJ5YwFLHmbPfpn1UrZSoZFt6tYDPWmd-MCNQWl-UvotdX-VtIQgV0UUaHUC5BIdYqxcRQT7RxBuWL_I0H4)

- Scroll down to the Granular Controls section. Set the “Protocols and Ports” value to ‘Any’.
- In the Action section, set the value to “Allow” and click the checkbox to enable Logging.
- Click ‘Save’.

![](https://lh5.googleusercontent.com/nGcNSDS5ZUyw80kvrPoVLd139wJZpVifBitWvaEL6_k5vuljkEY02TKlFSxRi6CTDkXHKXuMBsxUpLotkJgSVlsioao732eGQOPMTQm93yvosVGp85D6rr67XUZOxGcKWPKhrxBqavrd9tj96Tt81sc)

80. Navigate to the top right and using the dropdown next to ‘CONFIG ACTIONS’, select ‘Deploy Configuration’

![](https://lh3.googleusercontent.com/ssuUl2ZKsSyQV9kNwbQb6cmKgtnN-OGKo4JmuLyJckNJN7QOeHsKS77bGCKI5X2BNhjQYSmld-UwwK-gw3uPCcxkrRgcWpsz7zlR97iyBpvq_aDxNSbdoh9OyD77_qS5uYXJ8BwEJ8ndY4YdyUfHn2g)

81. Status changes to committing. You will see a pop up momentarily that the commit was successful.

![](https://lh4.googleusercontent.com/q8s25kdtTa9XgZad3E27BNh5C4MNvmdXyC96SkqTUbWEK-jVtBLethV5Trb-WNwMcq_SRytY7T9UMQlTuC7X26zHrSij6d0mq9RNR-lfaHn4DRV52GszJKGSfAM4IlODnxIzAYXjYZs1gd-3q6O46cw)

82. The Rulestack and Firewall Rule creation is completed.

<br/>

## Deploy CloudNGFW and create endpoint

We will now deploy the cloudNGFW service on the security VPC. The security VPC along with the Application and attack VPCs were provisioned using terraform.

83. Navigate to the AWS Console browser tab. Search for VPC and click on VPC.

![](https://lh5.googleusercontent.com/f6NaKV8jP8-tfmYt58waa1V2Fi_svl7_0grK2RcLc5uvC7CWKU1pPBzscENXFhz4LOAPHuOTA0ejgCJn-u-wobLyvDj9q2ikKjuhnMrQzfEc5_39MZW6X6I6eI8J1fo-DsvHL5ZriH5jKHzoBZ6JWgs)

84. Review the services that are already provisioned. Click on the ‘4’ against VPC to list the 4 VPC created.

Note that the name of the security VPC is “**qwikLABS-sec-vpc**”. We will be deploying the CLoudNGFW endpoint here. 

![](https://lh6.googleusercontent.com/7tMlPgcQZuDsWBdM9gN3K0eePLq5p2yYiSjTvzDyn2oZ0QRLsXaUnmgwyDyGHIwHc05LZMbkZ_DtqgL_T1n1XM81ZKxPpPZ03o4TXxXYfuwRfy-zgOeCzFBPymRLfQxexTtyIlRCJiBIxRLH3l05WGY)

![](https://lh5.googleusercontent.com/2xBafpO_71yrBVEXamRxw_RlfgY_RMCSv5l5f_1GSvo4dx_SWNhcAFk4FhFhm0MlxhkZxiy0vvE21GHCI-O1ZIwc3ekkFVUe3DbrQGc3q4wnWZjlobGIKC0urj_xuuaz_ZsQzSbh-rRGcrK_NCgatpY)

85. Navigate back to the Cloud NGFW browser tab and from the left vertical menu select ‘NGFWs’

![](https://lh6.googleusercontent.com/e3xdnYSNGxU7cd45aU0jEbBE1T2GhviXHXCdlID2_qMTpx9-LLIuNOKuq6U8nUdYZNC2noyVxksiVkj4a3QLrhd3AS-qqvqQbZnP5D585JtP_wHKdiU3P6JHY63SDE0MCppExEvzQA4B_xzZ6N3wHBo)

86. On the top right, click on ‘Create Firewall’

![](https://lh6.googleusercontent.com/_shcZlc-v4mJ_Ne1TBDku-ll2Q41zwt4j6LsCl1Rze1vnyN7Nh_BHoApWB7HsEPFllSxHsMAWITxsgKkUwe3MUHWeuAwrfPzJ28P__k2w0D6jDL9aiWrYSy11wjIGAZZaP20swZITGG3blP_Z11tLPU)

87. In the General section of the Create Firewall form, 
- Name your CloudNGFW instance ‘MyfirstCloudNGFW’
- Select your AWS account
- Set VPC to ‘qwikLABS-sec-vpc’

![](https://lh6.googleusercontent.com/uG9ZgL_QXrT5_DE3XcE6pM-7mYdODtzB5M2cwvMbpXPCjZ5Wif3x6XR8W6ftBT1P_E-TejLNiVn83prSHt10tIv_YQAyTuD3-ds64mh0GmeYnfVyHg8x0_AGBxAUnVAWNuU73gk2rBEaGnFeiG0eXbM)

88. In the Rulestack section of the Create Firewall form,
- Set Rulestack to ‘Rulestack1’ from dropdown
- Say yes to create endpoint
- Select qwikLABS-sec-vpc-subnet
- Click ‘Save’

![](https://lh3.googleusercontent.com/3FNRuH-ns-vaczaub_Qd6f1x8X15U5tPy8_o_rPbuNTYr2o23iJyrrD6nCbCa3cEA6xJcKl5dnuYxdpHR8iqfFaqBHpKkY4u90HFzZelLK-2Ex8JHE2OSxpRnnai78WPCO6iEBIi115H4G2DWpCZEYU)

![](https://lh3.googleusercontent.com/SfwzOJqInWrZSIN2gc2U1n2F1yFwXXnL2lV-cl9hTzsNeKrSgpcpzy5FTffTHCErY5TYhUZ4IVvbZhFnWUF92ReMuqM3jQ7KCCV4EIUM8_R3uB3rrKRt8mkzLYmK9pP1UT4n71hyczOWuYUFF1WaasI)

89. You have initiated deployment of CloudNGFW in the Qwiklab environment. The deployment will take around 10-15 mins to complete successfully.

<br/><br/>

# Activity 3: Secure

In this session we will be creating firewall policies and experience how the best practice default profiles give you protection against threats like Log4J.

<br/>

## Overview

- Configure Logging
- Route traffic from the Application and Attack VPCs to the Firewall through the Endpoint created in the Security VPC.
- Check connectivity between the Application and the Attack servers.
- Launch the attack from the Attack server to the Application
- Monitor the attack via Logs
- Set Recommended Profile
- Re-launch attack
- Monitor the attack via Logs

**Note:** Before you begin this activity, review the CloudNFGW deployment status. The status of the deployment should be CREATE_COMPLETE.  

![](https://lh4.googleusercontent.com/WEydPHcOYpyRBkqRmyomO06Dd1-6UfkCFdrUyym_YslfsgaYUBYBGzA9TIlvRfF2zC-9phcdI0iP9NdVkPbdXzbLzLXwKEDsi7bpnOABZx0Ui5DCXgEWDIyx7nPzBV78ARRY0dEHwM9r2Js8bfkXUGY)

**Figure:** Cloud NGFW Deployment Status

<br/>

## Configure Logging

90. Navigate to the AWS console browser tab. In the Search bar at the top, type “cloudwatch” and from the search results, click on ‘CloudWatch’.

![](https://lh6.googleusercontent.com/A6eaatDWB6kc2Ej8f0-y-tWOZL-cD-Ws0FSudRS8lA2nlhCSug0xTsGcvv_ZGNmgLrBPKynU4bZ58u1Zn9e5jlZ6p2hPHU1BUF0cO9eqh5nNgm2bBzDcWW7Ca3dR7wtDfx7y1MZSwi8Nx_gAoKgoJlw)

91. On the left menu, expand ‘Logs’ and click on ‘Log groups’. 
92. Navigate to right top corner and click on ‘Create log group’

![](https://lh3.googleusercontent.com/jM-mzkwDqyOiY1wHX7qhMlXvcQViYovTEuDmczkouSeEzJAFYu5MJEkLFJzmaWY6uHHWrSPeTUjThRSfjYAb32WlP0iwzbxQQZRuRLeYHk7GCfsRr1l47KZNszLlXis3Lite06CTAIUHjHLnrSPqjb4)

93. Set the log group name to **‘PaloAltoCloudNGFW’**. Note the name should match exactly in case. Click on ‘Create’.

![](https://lh6.googleusercontent.com/eQNt09fjAJoRNc6NPf7rsc3GRKSeMb7-e7sKq8fSCWgnzqx62VURXbyZu5rpXFjnnf5myYZeUDeo8eEp_LcPiouh5ScorocvqP361fdHYsPsK3ts_xmYxvt4GkTyef0Y8jGADz-ssME6cWsjuSYEgRk)

![](https://lh5.googleusercontent.com/6d0wpPqG_9I1T7uT3H9W1_NCsTIa16QA2rkDGcAk9bIoWF_w9b3E7Ifl0ltycFFW6EoqpVfGhhQpFmzwA_OAFYIcYNsnCJauxdz_hi1xXP2x2nEScifr45b35Y6pSBWdTrzIT_jXdhzD0xEBLmg9Lxs)

94. Navigate back to the CloudNGFW console.
95. Click on NGFWs and ‘myfirstCloudNGFW’

![](https://lh6.googleusercontent.com/PyfY5bolfUkyMAV18E_sFqwfyDN_oO_IlxX6vL7LYZ9m9foj5LNM6_sICCL56ZpgoJ4j8uk8CVtmp_UCPqkxg5dDOgzoVqH84Bmb-n3CVFQ31YlJAUO-W4NIp_6YMuyq1zWt-MVlrtMdoNuJIPxwpL8)

96. Navigate to the ‘Log Settings’ tab. In the Log Type section,
- Select checkboxes against TRAFFIC  and THREAT.
- Select the Log Destination Type as Cloudwatch Log Group and type in ‘PaloAltoCloudNGFW’ as Log Destination. Note that this is the CloudWatch Log Group that you just created.

![](https://lh4.googleusercontent.com/67LibvC4daSqzyJdvvXNKIQ2MS7YDPo4kPlZGlCVHy6nR2F32pIeu8D99FfgoR-vXkiXbVSOegkzTFA4_X8srRUvTZNC9A-6bfM5noVpSEppPSZUoBO9pn--2DVcd8ftB6xm46UEa7CbLNV43AAv7G8)

97. Navigate to the ‘Threat’ tab and do the same. Click save.

![](https://lh4.googleusercontent.com/n57JuoBPVCDCocMdI3qftzfAXf7qyd-mlpZVo1yDotcKXhfi-ZURJKcXAu2YSsnn1nrfY-eIIcFf6PDOasQi_De8ltDJFHZvSv0OE9y8UsKfNqPZsStu8YUxAZ6DiQk4j8vTw4iYq6tudeDMEMtolm8)

<br/>

## Route Traffic to Firewall

98. Navigate to the AWS Console browser tab. 
99. In the Search bar at the top of the page, type “vpc” and click on VPC from the search results.
100. In the left menu on the VPC console, click on _Transit gateway route tables_.
101. From the list of Transit gateway route tables, identify the route table with the name “**qwikLABS-from-app-vpcs**” and click on the _Transit gateway route table ID_ corresponding to it.

![](https://lh4.googleusercontent.com/8qmKOSisKTvPOk7IsFsaedVPxoNxt6VFhEF8UYrvLfRNqJGEBDCucwYk8UHbBsiQYcaFAVqKxPJRvZJ3aVL6WXIna8ACKgY3n8roAdp4okLOP66pBTn1KhnGoglddeaSAuWVp0L2nPM-TRv_zH3YPJ4)

102. Navigate to the _Routes_ tab, from the route table, select the static routes to the app servers and delete them one by one. Basically, we are deleting the direct static routes that allow East-West traffic between the app servers . This is because we want to route the East-West traffic between the app servers via the Cloud NGFW. 

![](https://lh5.googleusercontent.com/E9YucgxamVIKaN_HNSv25OeMAC3MukReTzen1Nch6B6_-QnJ22LvSmkyEp1Qvyk06wKKFT89TChXP02yUQtilLlMgkeSmGAFpOYIBz77CFmvt_MMybIhdlcsuWqZgkSRSapVm6xXcx3c0P5PbTnRB1k)

103. Once that’s done, again in the left menu on the VPC console, click on Route Tables. 

![](https://lh4.googleusercontent.com/qtl-niPTp7VtlIGCiFBIWNwGPQaO2ayjKA2zUoRfwORQ0P6dX6mgxHdsIPke8_Retvt_GvYtsiV9dnZkjHasFXBFdB5LhQKBrpHClkkKd2_PiidNtPbYTFle-5KCxaq47hQk-KlIXPdA1D2JDJYU-vU)

104. From the list of Route Tables, identify the route table with the name “**qwikLABS-sec-vpc-tgw-rt**” and click on the Route Table ID corresponding to it.
105. In the _Routes_ section of the selected Route Table, click on _Edit Routes_.

![](https://lh5.googleusercontent.com/zM8COgFlSva4fyLEMPgdyAFRkhVB41Uc8-RhkNRSPYK1R8owszNZJFmw4JAL8_f_TLhvfRY6l5q8uUwKqiu7gmAjdaLE1G1aZL-cvFWtVzV85KHr8NofuugcyF8N9liiRs84lLIPwTCHyVdKL0ac0qY)

106. On the _Edit Routes_ page, 
- add a route with destination 0.0.0.0/0. 
- In the Target field, select the GWLB (Gateway Load Balancer) Endpoint created by CloudNGFW.
- Save changes

![](https://lh5.googleusercontent.com/S4BlXjQP5RYMIGuvIkX3__-X7vSN6nYPaapj5iV8g0KmG2YNcmSefP_i3Xgn_r9V1hbJv9TxLiLYVeAELmjL-JJzO2mNCs7LYDOeOdAIlFmrDTHGBy7sN6I-BRGRh9CTduNOLbWSBD1HfoWELjr6DUk)

<br/>

## Launch the Log4J Attack

107. On the **att-app-server** command prompt, execute this command to launch the Log4J attack.

```
/tmp/launch_attack.sh
```

108. This time, you will not see the ‘Hello, world” message as the attack will have been blocked by the NGFW.

![](https://lh6.googleusercontent.com/n9Z6WR3jJHVxh_5N8TRB-IB2jW0mRal8FwYVW6w09968Gw-sLEB90cKNEdn6YCZsU7YjkgaV4qtV3fJ3yi41qsxIvQvehgUrMWWKulN-oyOH4phjTxzYfFJoEW6I-pMzkVxzCJCsmWfzV1zZ470)

<br/>

## Monitor threat log

109. Navigate to the AWS Console browser tab, on the Search bar at the top of the page, type “cloudwatch” and select “CloudWatch” from the search results.
110. From the left menu, click on “Log groups” and from the list of Log groups, select “PaloAltoCloudNGFW”.
111. Navigate to AWS CloudWatch browser tab and click on ‘Log Groups’
112. Click on the THREAT log file.

![](https://lh5.googleusercontent.com/6_x3TcTGkZv2VPIJBxeoDlDG980gohlde3O62gCeQwVsQ1gKf3D1psP9ERpFJTuThYbf0wRjKsJAp2kKzoP4RU7MZUL-Bh17YhSbaLy5yICANUnCFdNZV_BgheGiMOi-3YlQANcUcPtnsVQQz0poo68)

113. Click on the arrow to open the log. You can see that CloudNGFW successfully detected and prevented the attempted Log4J attack.

![](https://lh4.googleusercontent.com/QVyfTld7k4H5CjwDquHgjqsHjOW_bM-kEZSLgEEoF6oV1YbexVzilJpkWLVhuEIGMmaw_iD7Gg91SkV1h2Ap6ibzb6QOht0odJlAvfPC9c-1bWbvuzszM0WPUkXzgpiutjwQKOsnGEMqMCtUgLPiCFQ)

<br/>

## Play around with Security Profiles

114. On the CloudNGFW Console, navigate to _Rulestacks_ and click on ‘Rulestack1’

![](https://lh5.googleusercontent.com/VyhB6hAv8QO2H2bGa5jpDwY5LRyBo5A92qOSWCp0YGlnfTUaNaawJ8ty8fRA5uZh4AtH9tiul6S8HFASqjyj5I70RcsULOeqAXTtbaXEx1xXD3mI8d3jOHB6sZfPw3UggaC1B15aX4AImgG5yMr4naM)

115. Navigate to the ‘Security Profiles’ tab.

![](https://lh4.googleusercontent.com/8ekWbvx50uSvtmAmq9qO6tRzw9xxosIDVPNvv0OttCYdsFNFafudjkC3Aos6DwTXxhHhpJwj2kPxJVUG7yqYzg1zfNqNOtdaKYSivHfydKt4INktcqodf8kkM40GrDAgaajaEFjDa9HYdHGpOqzUdCk)

By default, IPS Vulnerability, Anti-Spyware, Antivirus and File Blocking features are enabled in the Security Profiles. This is what blocks the Log4J attack in the previous step. Just for the purpose of this activity, we can disable some of these profiles.

116. Disable IPS Vulnerability, Anti-Spyware, Antivirus and File Blocking.

![](https://lh6.googleusercontent.com/sfPF-dY13L4PCGcGsRZKet7g0596YboPv0yh-SYWzrVqfYTKuorC8ZRRLH882h9qbwHOye4TboGsRVQh9g-egzNVMXr_ga3ZndZwxiYkOnkzVPw4JrwFCmEA3_IEECfbvnEoQz9VUnJ9JLtHm_fkmGU)

117. From the ‘CONFIG ACTIONS’ dropdown list at the top-right side of the page, select ‘_Deploy Configuration_’.

![](https://lh4.googleusercontent.com/UqMcelwDqPiw9Z78GTOjAZMq2jjM4gWP1Tn6ydbHsV54ckD4tNJyPPe8Mb-moWsfTbuT1IcI1xi5pSUAsS7HE7mFWNlaCOKCluCgNEppmzX5s9Egdpq8Ez8qtjIGKc2_mbxOHFjWvVZBh-4jq9vONJw)

118. Commit status will change to ‘Pending’ and then ‘Success’

![](https://lh4.googleusercontent.com/5YFVro3b1fjIyK3flyHQuXZh8kpejcm4mqJhIUGxxJh1P-V1polTJz_XXa2gQQWo7goiojx3xATq7jiXWDfAOL7ZY1GpY8B34Q65oXIWgxAXnQa-IqnEf_kiEwdOPYPo9sFbZwII8TC-g5_tHRqUCAs)

<br/>

## Relaunch Attack

119. Navigate to att-app-server SSH session and launch the attack again.

```
/tmp/launch_attack.sh
```

120. You will get a “Hello, world!” message as a response indicating that the attack is successful.

![](https://lh5.googleusercontent.com/nFEEIa02sRhicmJFOl_pk-XQ3ZAI8AzJDKNVgFWCU7sMOnQcDRF9iv8UP5fPxPZVhehwRlZqUfcsBQDhXKIwQanRux1HluF9jky3NdkPQNpuyiUs8es5TLTNJYO1iqQNoNig_xjz6-WPhiHH_LtJhA)

121. Switch context to the **vul-app-server** SSH session and use the following commands to connect to the **vul-app-1 **container and view the /tmp directory. You will see that the vul-app server has been infected with malware.

```
sudo docker exec -it vul-app-1 /bin/sh
```

```
ls -alrt /tmp
```

![](https://lh5.googleusercontent.com/wDXixyTsMKEro1mx9hXN4snqToRVgFDSRDY5Vqj8r1LJvgKb4oxJqUEwhv1yfCqQRp7I2918YGw4wgYlMKVU3VKcYNsqivFmw6n_GOO6kw36n0G6f0jroR9vfO1aUVzdmChvKev_lbyuHodgi8oInzQ)

122. Verify the attack by checking the logs on CloudWatch. Navigate to the AWS Console browser tab, on the Search bar at the top of the page, type “cloudwatch” and select “CloudWatch” from the search results.
123. From the left menu, click on “Log groups” and from the list of Log groups, select “PaloAltoCloudNGFW”.

![](https://lh4.googleusercontent.com/NhHMFHA560c1XFo2XBLLESiqa16YBqh51v0F6AjvDApCP19vXeiIrR5UMtTm3G692Ox30bOCyj7yFeAdnxyRl-BRIlUi4FFXnSTsYOimRgX0wNkk-y-1WFCOb3Lm3Et59lJ8RYE1urcoYbG7lzfFM5w)

124. Open the TRAFFIC log file and you would see the sequence of a successful Log4J attack. Sessions on port 8080, 1389 and 8888.

![](https://lh5.googleusercontent.com/8hMPemMAJcDB2L1iBgOJw3zytcA4Hd9wBN9rK9vipv43xhy9L9c_ozIezHEonGVfa6g5KvNBkO1_WeDwX-GOJp_-RfjZjBCox75n2cWFtggQ_QFwswsDddk7qtvfKgutIzRNmoWRdPrjVSen-5ujoLA)

![](https://lh3.googleusercontent.com/0s3yG7299fXftitIBqgITrApBn15kw1-RLYvQMJo60tF7-DM_pMgtf7Hlfi-6Vrj9f-meCjS3ijqqZ6CDFFuiwyn00Bf_7JtQenSB_8AaW-Wn9V5E1LPDcnnso9TJxd2WrZhUTDlH10uK5CdO9i2Yls)

<br/>

## Enable Best Practice Security profiles

To secure the East-West traffic once again, you can update the Security Profiles on the Rulestack back to _Best Practice_ and relaunch the attack. This time the attack will be blocked by CloudNGFW.

<br/><br/>

# Congratulations!!!

Congratulations,  you have successfully completed this Hands ON lab. As part of this lab you went through the process to SUBSCRIBE to Palo Alto CloudNGFW Service on AWS. You familiarize yourself with ways to DEPLOY the service to protect your application on AWS. And finally, you learned how to SECURE your environment with ‘Best Practices’ security profiles from Palo Alto Networks.

<br/><br/>

# Lab Teardown

<br/>

## Unsubscribe from CloudNGFW Service

125. Navigate to the AWS Marketplace console. You can search for ‘market’ and click on ‘AWS Marketplace Subscriptions’.

![](https://lh4.googleusercontent.com/O5hgxnAoeoECZQ08ZRhA8gMvqFo2O3tpKKJkUzoAkVKmrHpmwvI9KXMeZdpawJgbu_-fF-dx0H6iQzZ4W4JJTt9N0DO9mgPc3MeLM2QYQJlS-O_rkE1wzGvZ9gU8WfkiOnEk0OEo67i774T_6oEy10A)

126. Click on ‘Cloud NGFW PAY-as…” service

![](https://lh3.googleusercontent.com/4aTSAiGs0nqdYUEYDuY-WaxvkjKc1xSGLsdyZpdTtdS9O6pzgbne3NUMTnlLhz7XHOcaJmOij_KlaEYbu6WaZzQI3E7aratcAcg2muuij9dGayEgCkjP7B2gvHkJL0EoiidW6-0almiUUi36PiezyQ4)

127. Click on ‘Action’ at the bottom of the page and click on ‘Cancel Subscription’

![](https://lh5.googleusercontent.com/G2u3Fh6Vcs8N3ropb_m1u5VSmqIfH-4Zc4CILY-F3R6VkwDYpXXy9SoxvA7rA8ZutG3m402tjmpp7_Ds-XCE8ktnn6xCSKryy3dKBCuP9jQKddB29op-XMJzmX7aBR_ktDLx2iDyrPJL32yLREsx1qI)

128. Select the checkbox to acknowledge and click on ‘Yes, cancel subscription’ 

![](https://lh3.googleusercontent.com/IUAPi4B9B-nT9da7P3P9SnvXiW014vR7FsRuAPy-vcpsQ7amLz9kjNRAmHxioV2SVqafs-c1sdeNCj7nkSfiPiGwYIwCXKUOdI_QEHRvbnbCEi-PzreZzT3nuVaBCG5jhU2yOHCnXKFUnKSqufJai2g)

![](https://lh6.googleusercontent.com/31pCarQ0Gty06az_aEBt0adXKWOjT_yhnYR33kug07SV73bZS1zUMotlqmuwTj5Cowipi7lcoI5atCx3OfFfSGxlBPyi3JmEFALcqPYAVqrg9J72m1esBhnH8AQcfuW1DVX59VSxJBNJcJD68U9Gb40)

129. You have successfully unsubscribed from the CloudNGFW service.

<br/><br/>

# Resources and Reference

Here are links to some of the resources for CloudNGFW service.

- [eBook: Cloud NGFW - Palo Alto Networks](https://www.paloaltonetworks.com/resources/ebooks/cloud-ngfw)
- [Cloud NGFW: Solution Brief - Palo Alto Networks](https://www.paloaltonetworks.com/resources/whitepapers/cloud-ngfw-solution-brief)
- [Cloud NGFW for AWS Datasheet - Palo Alto Networks](https://www.paloaltonetworks.com/resources/datasheets/cloud-ngfw-for-aws)
- [AWS Marketplace: Palo Alto Networks Cloud NGFW (Next-Generation Firewall) Pay-As-You-Go](https://aws.amazon.com/marketplace/pp/prodview-sdwivzp5q76f4#:~:text=7%2DDay%20Free%20Trial%3A%20Click,Get%20started%20today)!
- [Getting Started with Cloud NGFW for AWS](https://docs.paloaltonetworks.com/cloud-ngfw/aws/cloud-ngfw-on-aws/getting-started-with-cloud-ngfw-for-aws)

<br/><br/>

# Troubleshooting

<br/>

## Issues with the Lab Setup

In case you run into any errors during the execution of the setup script the deployment is a failure, you can follow the below steps;
- Run the setup script again. This should take care of any temporary issues like timeouts, etc.
- If you still see an error, reach out to your Lab Administrator for further steps.
- You can also open the _setup.sh_ script in an editor and attempt all the steps one by one in the same order as in the script from a separate terminal.

<br/>

## Docker related Issues

If the docker list command errors out or does not show the containers, use the following commands to start containers manually.

1. Try restarting the instance
2. If the att-svr container is not coming up, use this command to start it manually. At the command prompt, execute this command:

```
sudo docker container run -itd --rm --name att-svr -p 8888:8888 -p 1389:1389 us.gcr.io/panw-gcp-team-testing/qwiklab/pcc-log4shell/l4s-demo-svr:1.0
```

3. If the vul-app-1 container is not up, use this command to start it. At the command, prompt execute this command:

```
sudo docker container run -itd --rm --name vul-app-1 -p 8080:8080 us.gcr.io/panw-gcp-team-testing/qwiklab/pcc-log4shell/l4s-demo-app:1.0
```
